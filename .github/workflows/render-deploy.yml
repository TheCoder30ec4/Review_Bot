name: Deploy to Render

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Render Deployment
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "Triggering deployment at Render..."

          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{}' \
            "https://api.render.com/v1/services/$SERVICE_ID/deploys")

          DEPLOY_ID=$(echo "$RESPONSE" | jq -r '.id')

          if [ "$DEPLOY_ID" = "null" ] || [ -z "$DEPLOY_ID" ]; then
            echo "Failed to create deployment."
            echo "Response: $RESPONSE"
            exit 1
          fi

          echo "Deployment created: $DEPLOY_ID"
          echo "DEPLOY_ID=$DEPLOY_ID" >> "$GITHUB_ENV"

      - name: Wait for Render Deployment
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          DEPLOY_ID: ${{ env.DEPLOY_ID }}
        run: |
          echo "Polling deployment status..."

          STATUS="created"
          ATTEMPTS=0
          MAX_ATTEMPTS=40 # ~10 minutes

          while [[ "$STATUS" != "live" && "$STATUS" != "failed" && $ATTEMPTS -lt $MAX_ATTEMPTS ]]; do
            sleep 15
            ATTEMPTS=$((ATTEMPTS+1))

            RESPONSE=$(curl -s \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$SERVICE_ID/deploys/$DEPLOY_ID")

            STATUS=$(echo "$RESPONSE" | jq -r '.status')

            echo "Status: $STATUS (Attempt $ATTEMPTS/$MAX_ATTEMPTS)"
          done

          if [ "$STATUS" = "live" ]; then
            echo "Deployment successful!"
          else
            echo "Deployment failed or timed out."
            exit 1
          fi


